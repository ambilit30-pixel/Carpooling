{% extends 'rides/base.html' %}
{% block title %}Assign Driver{% endblock %}
{% block header_title %}Assign Driver{% endblock %}

{% block content %}
<style>
    /* Scoped styles for assign driver page */
    .assign-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(4, 88, 150, 0.06);
        max-width: 760px;
        margin: 8px auto;
    }

    .assign-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
    }

    .assign-head h2 {
        margin: 0;
        font-size: 20px;
        color: var(--text);
    }

    .muted {
        color: var(--muted);
        font-size: 14px;
    }

    .form-row {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 14px;
        flex-wrap: wrap;
    }

    .form-col {
        flex: 1 1 320px;
        min-width: 200px;
    }

    label.field-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--text);
        font-size: 14px;
    }

    select.driver-select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e8f3fb;
        background: linear-gradient(180deg, #fff, #fbfeff);
        font-size: 14px;
        color: var(--text);
        outline: none;
    }

    select.driver-select:focus {
        box-shadow: 0 6px 18px rgba(3, 102, 153, 0.08);
        border-color: var(--accent-2);
    }

    .capacity-info {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
        font-size: 13px;
        color: var(--muted);
    }

    .badge-cap {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--chip-bg);
        color: var(--chip-color);
        font-weight: 700;
        font-size: 13px;
    }

    .warning {
        color: #b45309;
        font-weight: 700;
    }

    .actions {
        margin-top: 18px;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .helper {
        margin-top: 10px;
        color: var(--muted);
        font-size: 13px;
    }

    @media (max-width:640px) {
        .assign-head {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .form-row {
            flex-direction: column;
            align-items: stretch;
        }
    }
</style>

<div class="assign-card" role="region" aria-labelledby="assignTitle">
    <div class="assign-head">
        <div>
            <h2 id="assignTitle">Assign Driver</h2>
            <div class="muted">For ride: <strong>{{ ride.source }} → {{ ride.destination }}</strong></div>
            <div class="helper">Committed seats: <strong>{{ ride.total_committed }}</strong></div>
        </div>

        <div style="text-align:right">
            <a class="btn ghost" href="{% url 'rides:ride_detail' ride.id %}">Back to ride</a>
        </div>
    </div>

    <form method="post" id="assignDriverForm" novalidate>
        {% csrf_token %}
        <div class="form-row">
            <div class="form-col">
                <label class="field-label" for="driver_id">Select driver</label>
                <select id="driver_id" name="driver_id" class="driver-select" required aria-required="true">
                    <option value="" selected disabled>— choose a driver —</option>
                    {% for d in drivers %}
                    <option value="{{ d.user.id }}" data-capacity="{{ d.capacity|default:0 }}">
                        {{ d.user.username }} — capacity: {{ d.capacity|default:"N/A" }}{% if d.user.first_name %} — {{
                        d.user.first_name }}{% endif %}
                    </option>
                    {% endfor %}
                </select>

                <div class="capacity-info" id="capacityInfo" aria-live="polite" style="display:none">
                    <div>Driver capacity:</div>
                    <div class="badge-cap" id="selectedCapacity">—</div>
                    <div id="capacityNote" class="muted" style="margin-left:6px"></div>
                </div>

                <div class="helper">Tip: choose a driver whose capacity is ≥ committed seats to avoid overbooking.</div>
            </div>

            <div style="min-width:220px;align-self:flex-start">
                <label class="field-label">Quick stats</label>
                <div
                    style="background:linear-gradient(180deg,#fbfdff,#ffffff); padding:12px; border-radius:8px; border:1px solid #eef6ff">
                    <div class="muted">Total committed</div>
                    <div style="font-weight:700;font-size:18px;margin-top:6px">{{ ride.total_committed }}</div>

                    <div style="margin-top:12px" class="muted">Available drivers</div>
                    <div style="margin-top:8px">
                        <span class="badge-cap">{{ drivers|length }}</span>
                        <span class="muted" style="margin-left:8px">drivers found</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button id="assignBtn" class="btn" type="submit" disabled>Assign driver</button>
            <a class="btn ghost" href="{% url 'rides:dashboard' %}">Cancel</a>
        </div>
    </form>
</div>

<script>
    (function () {
        const select = document.getElementById('driver_id');
        const capacityInfo = document.getElementById('capacityInfo');
        const selectedCapacity = document.getElementById('selectedCapacity');
        const capacityNote = document.getElementById('capacityNote');
        const assignBtn = document.getElementById('assignBtn');
        const committed = Number({{ ride.total_committed |default: "0" }});

    function resetInfo() {
        capacityInfo.style.display = 'none';
        selectedCapacity.textContent = '—';
        capacityNote.textContent = '';
        assignBtn.disabled = true;
    }

    function onChange() {
        const opt = select.options[select.selectedIndex];
        if (!opt || !opt.value) { resetInfo(); return; }

        const cap = Number(opt.dataset.capacity || 0);
        capacityInfo.style.display = 'flex';
        selectedCapacity.textContent = (isNaN(cap) ? 'N/A' : cap);

        if (isNaN(cap) || cap === 0) {
            capacityNote.textContent = 'Capacity not set for this driver';
            capacityNote.className = 'muted';
            assignBtn.disabled = true;
            return;
        }

        if (cap < committed) {
            capacityNote.textContent = '⚠️ Not enough capacity — will overbook';
            capacityNote.className = 'warning';
            assignBtn.disabled = false; // allow assign but user is warned
        } else {
            capacityNote.textContent = 'Capacity ok';
            capacityNote.className = 'muted';
            assignBtn.disabled = false;
        }
    }

    // initialize (in case a value was preselected)
    resetInfo();
    select.addEventListener('change', onChange);

    // optional: client-side confirm if overbook
    document.getElementById('assignDriverForm').addEventListener('submit', function (e) {
        const opt = select.options[select.selectedIndex];
        if (!opt || !opt.value) {
            e.preventDefault();
            select.focus();
            return;
        }
        const cap = Number(opt.dataset.capacity || 0);
        if (!isNaN(cap) && cap < committed) {
            // show native confirm when assigning to smaller capacity
            const ok = confirm('Selected driver capacity (' + cap + ') is less than committed seats (' + committed + '). Assign anyway?');
            if (!ok) {
                e.preventDefault();
                return;
            }
        }
        // otherwise allow form submit
    });
  }) ();
</script>
{% endblock %}